<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Prediction</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../welcome.html">Welcome</a></li><li class="chapter-item "><a href="../lesson1/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item "><a href="../lesson2/metrics-and-evaluation.html"><strong aria-hidden="true">2.</strong> Metrics and Evaluation</a></li><li class="chapter-item "><a href="../lesson3/pipelining.html"><strong aria-hidden="true">3.</strong> Pipelining</a></li><li class="chapter-item expanded "><a href="../lesson4/branches.html"><strong aria-hidden="true">4.</strong> Branches</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lesson4/prediction.html" class="active"><strong aria-hidden="true">4.1.</strong> Prediction</a></li><li class="chapter-item "><a href="../lesson4/branch-target-buffer.html"><strong aria-hidden="true">4.2.</strong> Branch Target Buffer</a></li><li class="chapter-item "><a href="../lesson4/direction-predictor.html"><strong aria-hidden="true">4.3.</strong> Direction Predictor</a></li><li class="chapter-item "><a href="../lesson4/2-bit-predictor.html"><strong aria-hidden="true">4.4.</strong> 2 Bit Predictor</a></li><li class="chapter-item "><a href="../lesson4/history-based-predictors.html"><strong aria-hidden="true">4.5.</strong> History Based Predictors</a></li><li class="chapter-item "><a href="../lesson4/pshare.html"><strong aria-hidden="true">4.6.</strong> PShare</a></li><li class="chapter-item "><a href="../lesson4/tournament-predictor.html"><strong aria-hidden="true">4.7.</strong> Tournament Predictor</a></li><li class="chapter-item "><a href="../lesson4/return-address-stack.html"><strong aria-hidden="true">4.8.</strong> Return Address Stack</a></li></ol></li><li class="chapter-item "><a href="../lesson5/predication.html"><strong aria-hidden="true">5.</strong> Predication</a></li><li class="chapter-item "><a href="../lesson6/ilp.html"><strong aria-hidden="true">6.</strong> Instruction Level Parallelism</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../lesson6/false-deps.html"><strong aria-hidden="true">6.1.</strong> False Dependencies</a></li><li class="chapter-item "><a href="../lesson6/what-is-ilp.html"><strong aria-hidden="true">6.2.</strong> What is ILP?</a></li></ol></li><li class="chapter-item "><a href="../lesson7/instruction-scheduling.html"><strong aria-hidden="true">7.</strong> Instruction Scheduling</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../lesson7/issuing.html"><strong aria-hidden="true">7.1.</strong> Tomasulo's Algorithm - Issuing</a></li><li class="chapter-item "><a href="../lesson7/dispatching.html"><strong aria-hidden="true">7.2.</strong> Tomasulo's Algorithm - Dispatching</a></li><li class="chapter-item "><a href="../lesson7/writing.html"><strong aria-hidden="true">7.3.</strong> Tomasulo's Algorithm - Writing</a></li><li class="chapter-item "><a href="../lesson7/review.html"><strong aria-hidden="true">7.4.</strong> Tomasulo's Algorithm - Review</a></li><li class="chapter-item "><a href="../lesson7/load-and-store.html"><strong aria-hidden="true">7.5.</strong> Tomasulo's Algorithm - Load and Store</a></li><li class="chapter-item "><a href="../lesson7/timing.html"><strong aria-hidden="true">7.6.</strong> Tomasulo's Algorithm - Timing</a></li></ol></li><li class="chapter-item "><a href="../lesson8/rob.html"><strong aria-hidden="true">8.</strong> Reorder Buffer</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../lesson8/rob-in-depth.html"><strong aria-hidden="true">8.1.</strong> ROB In Depth</a></li><li class="chapter-item "><a href="../lesson8/recovery.html"><strong aria-hidden="true">8.2.</strong> Recovery</a></li><li class="chapter-item "><a href="../lesson8/rob-timing.html"><strong aria-hidden="true">8.3.</strong> ROB Timing</a></li><li class="chapter-item "><a href="../lesson8/extra-topics.html"><strong aria-hidden="true">8.4.</strong> Extra Topics</a></li></ol></li><li class="chapter-item "><a href="../lesson9/memory-ordering.html"><strong aria-hidden="true">9.</strong> Memory Ordering</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../lesson9/load-store-queue.html"><strong aria-hidden="true">9.1.</strong> Load-Store Queue</a></li><li class="chapter-item "><a href="../lesson9/ooo-load-store-execution.html"><strong aria-hidden="true">9.2.</strong> OOO Load/Store Execution</a></li><li class="chapter-item "><a href="../lesson9/summary.html"><strong aria-hidden="true">9.3.</strong> Summary</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#prediction" id="prediction">Prediction</a></h1>
<h2><a class="header" href="#branch-prediction-requirements" id="branch-prediction-requirements">Branch prediction requirements</a></h2>
<p>What do we need in order to successfully predict whether a branch will be taken
or not? What do need in order to determine where the branch is going if it's
taken?</p>
<p>The requirements are as follows:</p>
<ul>
<li>Branch prediction needs to work using only the knowledge of where we fetch the
current instruction from.
<ul>
<li>We need branch prediction to guess the program counter of the next
instruction to fetch.</li>
</ul>
</li>
<li>With branch prediction we must correctly guess:
<ul>
<li>Is this a branch?</li>
<li>If it is a branch, is it taken?</li>
<li>If it is a taken branch, what is the target program counter?</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#branch-prediction-accuracy" id="branch-prediction-accuracy">Branch prediction accuracy</a></h2>
<p>The image below demonstrates how we can calculate the theoretical CPI of a
processor using branch prediction given its branch prediction accuracy,
penalty per missed prediction, and percentage of instructions that constitute
branches within a benchmark program. The equation is contains these components:</p>
<ul>
<li><code>base CPI</code> - in the example below, this is <code>1</code>.</li>
<li><code>predictor accuracy</code> - this is the number of mis-predicted branches per
instruction.</li>
<li><code>penalty incurred</code> - the penalty is dictated by the number of stages in a
pipeline and when the branch instruction is evaluated.</li>
</ul>
<p>A more accurate branch predictor increases our performance, decreasing the
number of penalties taken for mis-predicted branches, thus decreasing our CPI.
The amount of help a better predictor has changes depending upon how long the
processor pipeline is. Longer pipelines benefit more from better branch
prediction than shorter ones.</p>
<p><img src="./img/branch-prediction-accuracy.png" alt="branch-prediction-accuracy" /></p>
<p>Below is branch prediction example problem. The key to this problem is the fact
that no branch prediction is being conducted so, until each instruction is
decoded, another instruction will not be fetched, thus creating a bubble within
the pipeline. So, non-branch instructions will take 2 cycles to execute and
branch instructions will take 3 cycles to execute. Instructions will not be
fetched after a branch instruction is decoded because the branch instruction
still has to be evaluated prior to fetching from the possible branch
destination.</p>
<p>In contrast, each instruction for the perfect branch predictor takes 1
instruction, no bubbles exist within the processor pipeline. This is because
the branch predictor knows which instruction will be fetched next before the
previous one is decoded - including the branches.</p>
<p><img src="./img/branch-prediction-benefit-quiz.png" alt="branch-prediction-benefit-quiz" /></p>
<h2><a class="header" href="#performance-with-not-taken-prediction" id="performance-with-not-taken-prediction">Performance with not-taken prediction</a></h2>
<p>A simple implementation of branch prediction that has an increase in performance
over just not predicting branches at all is the prediction that all branches
are <strong>not taken</strong>. If no predictions are made, ever, and instructions are only
fetched after previous instructions are decoded, branches will always take 3
cycles in our example 5 stage pipeline and regular instructions will take 2
cycles.</p>
<p>If we always assume the branch is not taken, sometimes we'll be right and the
branch will only use 1 cycle, while sometimes we'll be wrong and the branch
will use 3 cycles - this is still better than making no predictions at all. In
this model, regular instructions only take 1 cycle, as well.</p>
<p><img src="./img/not-taken-prediction.png" alt="not-taken-prediction" /></p>
<h2><a class="header" href="#predict-not-taken" id="predict-not-taken">Predict not-taken</a></h2>
<p>The <strong>predict not-taken</strong> predictor is the simplest predictor we can have, all
it does is increment the program counter. No extra hardware is required to
support the predict not-taken predictor - we should always have the ability to
increment the program counter.</p>
<p>A rule of thumb in computer architecture is that
<strong>20 percent of all instructions are branches</strong>. For branches, about
<strong>60 percent of all branches are taken</strong>. Thus, the predict not-taken predictor
is correct 80 percent of the time (because of non-branch instructions), plus
another 8 percent of the time (because of branch instructions). Overall, the
predict not-taken predictor is incorrect 12 percent of the time.</p>
<p><img src="./img/predict-not-taken.png" alt="predict-not-taken" /></p>
<h2><a class="header" href="#why-do-we-need-better-prediction" id="why-do-we-need-better-prediction">Why do we need better prediction?</a></h2>
<p>The image below provides examples for different types of pipelines, showcasing
the differences in performance using a predict not-taken predictor and a
branch predictor that is correct 99 percent of the time. As you can see, as the
processor pipeline gets longer and more complex, conducting more instructions
per cycle, branch prediction becomes really important for performance. The
ability to accurately predict branches achieves a speedup of 4 for the case
of the 14 stage pipeline with 4 instructions per cycle.</p>
<p><img src="./img/better-prediction.png" alt="better-prediction" /></p>
<h2><a class="header" href="#predictor-impact-quiz" id="predictor-impact-quiz">Predictor impact quiz</a></h2>
<p>Below is an example quiz that demonstrates how we can determine the impact
of a predictor on the CPI of a processor pipeline. Given some metrics about the
Pentium 4 processor, we are given a final CPI but not the theoretically ideal
CPI of the pipeline. Using the metrics given, we have to derive the ideal CPI
and then calculate the new CPI given a different mis-prediction percentage for
our predictor.</p>
<p><img src="./img/predictor-impact-quiz.png" alt="predictor-impact-quiz" /></p>
<h2><a class="header" href="#why-we-need-better-prediction-part-2" id="why-we-need-better-prediction-part-2">Why we need better prediction, part 2</a></h2>
<p>The below image displays how wasteful flushing the processor pipeline is when
we fail to accurately predict branches. Depending upon how many stages are
within a pipeline, while also accounting for the fact that we could execute
multiple instructions per cycle, we see that would fetch and flush anywhere from
2, to 10, to 40 instructions - pretty wasteful.</p>
<p><img src="./img/better-prediction-2.png" alt="better-prediction-2" /></p>
<h2><a class="header" href="#how-do-we-get-better-prediction" id="how-do-we-get-better-prediction">How do we get better prediction?</a></h2>
<p>In a <a href="#branch-prediction-requirements">previous section</a>, we discussed the
requirements that needed to be met in order to conduct branch prediction. In the
image below, the lecture discusses that we don't have the ability to determine
if the instruction is a branch, if the instruction is taken, or what the offset
of the branch is because we still have yet to fetch the instruction.</p>
<p>What we do know, however, is that, based upon the program counter, we have a
historical precedence for what happened at this program counter in the past. We
know how the branch at this program counter was behaving in the past - we can
use this information because it's pretty common that branches tend to behave the
same way each time they are encountered.</p>
<p>We don't know what the current branch instruction to be fetched is going to do,
but we can make a prediction based upon its history / the last time it was
executed.</p>
<p><img src="./img/better-prediction-3.png" alt="better-prediction-3" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../lesson4/branches.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../lesson4/branch-target-buffer.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../lesson4/branches.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../lesson4/branch-target-buffer.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
